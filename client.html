<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>File Transfer System - Client Panel</title>
  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <!-- SweetAlert2 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">
</head>
<body class="bg-light d-flex align-items-center justify-content-center min-vh-100">
  <div class="card shadow-lg p-4 w-100" style="max-width: 960px;">
    <!-- Client Section -->
    <div id="client-section">
      <h2 class="h4 fw-semibold mb-3">Available Files</h2>
      <div class="d-flex justify-content-between align-items-center mb-3">
        <input type="text" id="client-search-input" placeholder="Search files..." class="form-control w-50">
        <div>
          <button id="client-prev-page" class="btn btn-secondary me-2">Previous</button>
          <span id="client-page-info" class="mx-2"></span>
          <button id="client-next-page" class="btn btn-secondary">Next</button>
        </div>
      </div>
      <div class="table-responsive">
        <table class="table table-striped table-bordered">
          <thead>
            <tr>
              <th>Title</th>
              <th>Filename</th>
              <th>Size (KB)</th>
              <th>Upload Date</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="client-file-table"></tbody>
        </table>
      </div>
      <button id="logout-client" class="btn btn-danger w-100">Logout</button>
    </div>
  </div>

  <!-- Bootstrap 5 JS (with Popper.js) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
  <!-- SweetAlert2 JS -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <script>
    const tokenKey = 'authToken';
    let clientCurrentPage = 1;
    const pageSize = 5;

    // Check if user is authorized
    // const token = localStorage.getItem(tokenKey);
    // if (!token) {
    //   window.location.href = '/index.html';
    // } else {
    //   try {
    //     const payload = JSON.parse(atob(token.split('.')[1]));
    //     if (payload.role !== 'client') {
    //       localStorage.removeItem(tokenKey);
    //       window.location.href = '/index.html';
    //     } else {
          fetchClientFiles();
    //     }
    //   } catch (err) {
    //     console.error('Invalid token:', err);
    //     localStorage.removeItem(tokenKey);
    //     window.location.href = '/index.html';
    //   }
    // }

    // Fetch files for client
    async function fetchClientFiles(search = '') {
      try {
        const response = await fetch(`/client/files?page=${clientCurrentPage}&size=${pageSize}&search=${encodeURIComponent(search)}`, {
          headers: { 'Authorization': `Bearer ${localStorage.getItem(tokenKey)}` }
        });
        const data = await response.json();
        if (data.error) throw new Error(data.error);
        const fileTable = document.getElementById('client-file-table');
        fileTable.innerHTML = '';
        console.log(data);
        
        data.files.forEach(file => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${file.filetitle}</td>
            <td>${file.filename}</td>
            <td>${(file.size / 1024).toFixed(2)}</td>
            <td>${new Date(file.upload_date).toLocaleString()}</td>
            <td>
              <a href="/client/download/${file.id}" class="btn btn-primary btn-sm">Download</a>
            </td>`;
          fileTable.appendChild(tr);
        });
        document.getElementById('client-page-info').textContent = `Page ${data.currentPage} of ${data.totalPages}`;
        document.getElementById('client-prev-page').disabled = data.currentPage === 1;
        document.getElementById('client-next-page').disabled = data.currentPage === data.totalPages;
      } catch (err) {
        console.error('Fetch client files error:', err);
        Swal.fire({
          icon: 'error',
          title: 'Error',
          text: 'Failed to fetch files. Please try again.',
        });
      }
    }

    // Client search and pagination
    document.getElementById('client-search-input').addEventListener('input', (e) => {
      clientCurrentPage = 1;
      fetchClientFiles(e.target.value);
    });
    document.getElementById('client-prev-page').addEventListener('click', () => {
      if (clientCurrentPage > 1) {
        clientCurrentPage--;
        fetchClientFiles(document.getElementById('client-search-input').value);
      }
    });
    document.getElementById('client-next-page').addEventListener('click', () => {
      clientCurrentPage++;
      fetchClientFiles(document.getElementById('client-search-input').value);
    });

  

     function handleAdminLogout(event, url) {
            event.preventDefault(); // Prevent the default form submission


            fetch(url, { // Send the FormData object to the specified route
                method: 'POST',
            })
                .then(response => response.json())
                .then(data => {
                    console.log(data);
                    if (data) {
                        Swal.fire({
                            title: data.title,
                            text: data.message,
                            confirmButtonText: "OK",

                            icon: data.icon
                        }).then((result) => {
                            /* Read more about isConfirmed, isDenied below */
                            if (result.isConfirmed) {
                                if (data.redirect != undefined) {
                                    window.location.href = data.redirect; // Replace with your desired URL
                                }
                            }
                        });
                    } // Handle the response data
                })
                .catch(error => {
                    console.error('Error:', error); // Handle any errors
                });
        }
     // Attach event listeners to each form, passing the appropriate endpoint URL
        document.getElementById('logout-client').addEventListener('click', function (e) {
            handleAdminLogout(e, '/clientlogout');
                  window.location.href = '/index.html';

        });
  </script>
</body>
</html>